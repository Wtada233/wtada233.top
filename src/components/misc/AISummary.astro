--- 
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { getLangFromPathname } from "@utils/i18n-runtime";

export interface Props {
	content: string;
	lang?: string;
}

let { content, lang } = Astro.props;

// Get current lang from URL if not provided
if (!lang) {
	lang = getLangFromPathname(Astro.url.pathname);
}

// å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œä¸æ¸²æŸ“ç»„ä»¶
if (!content || content.trim() === "") {
	return null;
}
---

{content && (
  <div class="ai-summary">
    <div class="ai-title">
      <div class="ai-title-left">
        <img width="25" height="25" src="/gemini-color.png" alt="gemini-ai">
        <span class="ai-title-text translation-unit">{i18n(I18nKey.aiSummary, {}, lang)}</span>
      </div>
      <div class="ai-tag">
        <span class="translation-unit">{i18n(I18nKey.aiModel, {}, lang)}</span>
      </div>
    </div>
    <div class="ai-explanation" data-lang={lang} data-content={content}></div>
  </div>
)}

<script>
  import { setupComponent } from "@utils/lifecycle";

  let typeWriterTimeout: number | undefined;

  function runAITypingAnimation() {
    const summaries = document.querySelectorAll('.ai-summary .ai-explanation');
    
    summaries.forEach(element => {
      const textElement = element as HTMLElement;
      if (textElement.hasAttribute('data-ai-typing-initialized')) return;
      textElement.setAttribute('data-ai-typing-initialized', 'true');

      const content = textElement.dataset.content || '';
      const typeSpeed = 30; // ms
      
      textElement.textContent = '';
      textElement.classList.remove('typing-complete');
      
      let index = 0;
      
      function typeWriter() {
        if (!document.body.contains(textElement)) {
          if (typeWriterTimeout) clearTimeout(typeWriterTimeout);
          return;
        }

        if (index < content.length) {
          textElement.textContent += content.charAt(index);
          index++;
          typeWriterTimeout = window.setTimeout(typeWriter, typeSpeed);
        } else {
          textElement.classList.add('typing-complete');
        }
      }
      
      // Delay to start typing for dramatic effect
      typeWriterTimeout = window.setTimeout(typeWriter, 800);
    });
  }

  const cleanup = () => {
    if (typeWriterTimeout) {
      clearTimeout(typeWriterTimeout);
      typeWriterTimeout = undefined;
    }
  };

  setupComponent('AISummary', runAITypingAnimation, cleanup);
</script>

<style>
/* =================== */
/* ğŸ“˜ AI æ‘˜è¦æ¨¡å—æ ·å¼ */
/* =================== */

.ai-summary {
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    border-radius: 12px;
    padding: 8px 8px 12px 8px;
    line-height: 1.3;
    flex-direction: column;
    margin-bottom: 16px;
    display: flex;
    gap: 5px;
    position: relative;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
}

.ai-summary:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.ai-summary .ai-explanation {
    z-index: 10;
    padding: 8px 12px;
    font-size: 15px;
    line-height: 1.4;
    @apply text-black/90 dark:text-white/90;
    text-align: justify;
}

/* âœ… æ‰“å­—æœºå…‰æ ‡åŠ¨ç”» */
.ai-summary .ai-explanation::after {
    content: '';
    display: inline-block;
    width: 8px;
    height: 2px;
    margin-left: 2px;
    @apply bg-black/90 dark:bg-white/90;
    vertical-align: bottom;
    animation: blink-underline 1s ease-in-out infinite;
    transition: all 0.3s;
    position: relative;
    bottom: 3px;
}

/* æ‰“å­—å®Œæˆåéšè—å…‰æ ‡ */
.ai-summary .ai-explanation.typing-complete::after {
    display: none;
}

.ai-summary .ai-title {
    z-index: 10;
    font-size: 14px;
    display: flex;
    border-radius: 8px;
    align-items: center;
    position: relative;
    padding: 0 12px;
    cursor: default;
    user-select: none;
}

.ai-summary .ai-title .ai-title-left {
    display: flex;
    align-items: center;
    color: var(--primary);
}

.ai-summary .ai-title .ai-title-left img {
    margin-right: 6px;
    border-radius: 20px;
    display: block;
}

.ai-summary .ai-title .ai-title-left .ai-title-text {
    font-weight: 500;
}

.ai-summary .ai-title .ai-tag {
    color: var(--btn-content);
    font-weight: 300;
    margin-left: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.3s;
}

/* âœ… æ‰“å­—æœºå…‰æ ‡é—ªçƒåŠ¨ç”» */
@keyframes blink-underline {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0;
    }
}
</style>