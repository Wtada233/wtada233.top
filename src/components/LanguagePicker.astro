---
import Icon from "@components/common/Icon.astro";
import { SUPPORTED_LANGUAGES, type SupportedLanguage } from "@utils/i18n-runtime";

const langNames: Record<SupportedLanguage, string> = {
	en: "English",
	zh_CN: "简体中文",
	zh_TW: "繁體中文",
	ja: "日本語",
	ko: "한국어",
};
---

<div id="language-picker" class="relative z-50" role="menu" tabindex="-1">
    <button aria-label="Switch Language" role="menuitem" class="relative btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90" id="language-switch">
        <Icon name="material-symbols:language" class="text-[1.25rem]"></Icon>
    </button>

    <div id="language-panel" class="absolute transition float-panel-closed top-11 -right-2 pt-5" >
        <div class="card-base float-panel p-2">
            {SUPPORTED_LANGUAGES.map((lang) => (
                <button class="flex transition whitespace-nowrap items-center !justify-start w-full btn-plain scale-animation rounded-lg h-9 px-3 font-medium active:scale-95 mb-0.5 lang-option"
                        data-lang={lang}
                >
                    {langNames[lang]}
                </button>
            ))}
        </div>
    </div>
</div>

<style>
    .active {
        color: var(--primary);
    }
</style>

<script>
    import { type SupportedLanguage, getLangFromPathname, setStoredLanguage, getLanguageSwitchUrl } from "@utils/i18n-runtime";

    function initLanguagePicker() {
        const picker = document.getElementById('language-picker');
        const switchBtn = document.getElementById('language-switch');
        const panel = document.getElementById('language-panel');
        const options = document.querySelectorAll('.lang-option');

        if (!picker || !switchBtn || !panel || picker.dataset.initialized) return;
        picker.dataset.initialized = "true";

        const currentLang = getLangFromPathname(window.location.pathname);
        options.forEach(opt => {
            if ((opt as HTMLElement).dataset.lang === currentLang) {
                opt.classList.add('active');
            }
        });

        const togglePanel = () => panel.classList.toggle("float-panel-closed");
        const hidePanel = () => panel.classList.add("float-panel-closed");

        switchBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            togglePanel();
        });

        picker.addEventListener('mouseleave', hidePanel);

        options.forEach(opt => {
            opt.addEventListener('click', () => {
                const lang = (opt as HTMLElement).dataset.lang as SupportedLanguage;
                if (lang === currentLang) return;

                setStoredLanguage(lang);
                window.location.href = getLanguageSwitchUrl(lang, window.location.href);
            });
        });
    }

    import { setupComponent } from "@utils/lifecycle";
    setupComponent('LanguagePicker', initLanguagePicker);
</script>
