---
import WidgetLayout from "@components/widget/WidgetLayout.astro";
import { seriesConfig } from "@configs/series";
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import { getPostSeries, getPostTranslation } from "@utils/content-utils";
import { getLangFromPathname, type SupportedLanguage } from "@utils/i18n-runtime";
import { getPostUrlBySlug } from "@utils/url-utils";

const COLLAPSED_HEIGHT = "7.5rem";

interface Props {
	class?: string;
	style?: string;
	series: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
const seriesName = Astro.props.series;

const series = seriesConfig.enabled ? await getPostSeries(seriesName) : [];

const isCollapsed = series.length >= 10;

// Get current lang from URL
const lang = getLangFromPathname(Astro.url.pathname);

const postWithTranslation = series.find((p) => p.translations[lang as SupportedLanguage]);
const representativePost = postWithTranslation || series[0];
const localizedName = representativePost ? getPostTranslation(representativePost, lang).data.series : seriesName;
---
{seriesConfig.enabled && series.length > 0 &&
  <WidgetLayout id="series" isCollapsed={isCollapsed} collapsedHeight={COLLAPSED_HEIGHT} class={className} style={style}>
      <Fragment slot="name">
            <span class="translation-unit">
                {i18n(I18nKey.series, {}, lang) + " - " + localizedName}
            </span>
      </Fragment>
      <div class="flex flex-col gap-1">
          {series.map(t => {
              const trans = getPostTranslation(t, lang);
              return (
                <a href={getPostUrlBySlug(t.slug, lang)}
                    aria-label={trans.data.title}
                    class="group btn-plain h-10 w-full rounded-lg hover:text-[initial]"
                >
                    <!-- dot and line -->
                    <div class="w-[15%] md:w-[10%] relative dash-line h-full flex items-center">
                        <div class="transition-all mx-auto w-1 h-1 rounded group-hover:h-5
                        bg-[oklch(0.5_0.05_var(--hue))] group-hover:bg-[var(--primary)]
                        outline outline-4 z-50
                        outline-[var(--card-bg)]
                        group-hover:outline-[var(--btn-plain-bg-hover)]
                        group-active:outline-[var(--btn-plain-bg-active)]
                        "
                        ></div>
                    </div>
                    <!-- post title -->
                    <div class="w-[85%] text-left font-bold
                        group-hover:translate-x-1 transition-all group-hover:text-[var(--primary)]
                        text-75 pr-16 whitespace-nowrap overflow-ellipsis overflow-hidden" title={trans.data.title}
                    >
                        <span class="translation-unit">
                            {trans.data.title}
                        </span>
                    </div>
                </a>
              );
          })}
      </div>
  </WidgetLayout>
}
